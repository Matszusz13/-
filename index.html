<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>üíñ Dla Ciebie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Cormorant+Garamond:wght@400;600&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
:root{
  --bg1:#120014;
  --bg2:#2a0030;
  --text:#ffe9ff;
  --muted:#ffd0ffcc;
  --accent:#ff4da6;
  --accent2:#ff7aa8;

  --glass2: rgba(0,0,0,.55);
  --glassBorder: rgba(255,255,255,.18);

  --paper:#fff7fb;
  --paperText:#240018;

  /* dynamiczne dopasowanie tekstu listu (JS mo≈ºe zmniejszaƒá) */
  --paper-title: clamp(32px, 7vw, 62px);
  --paper-font:  clamp(18px, 3.8vw, 26px);

  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  overflow:hidden;
  font-family:Poppins,system-ui,sans-serif;
  background:linear-gradient(160deg,var(--bg1),var(--bg2));
  color:var(--text);
}

/* ===== T≈ÅO MP4 ===== */
#bgVideo{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:0;
  opacity:0;
  transition:opacity 1.4s ease;
  filter:saturate(1.05) contrast(1.03);
}

/* ===== ETAPY ===== */
.stage{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  z-index:10;
  pointer-events:auto;
}
.hidden{display:none !important}

/* ETAP 1 */
.stage1{
  background:
    radial-gradient(900px 600px at 50% 40%, #ff4da61f, transparent 70%),
    linear-gradient(160deg, #0b000e, #230027);
}
.bigStartBtn{
  width:clamp(210px,60vw,360px);
  height:clamp(210px,60vw,360px);
  border-radius:50%;
  border:none;
  font-size:clamp(22px,5vw,34px);
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#120016;
  animation:pulse 1.2s infinite;
  box-shadow:0 18px 65px #ff2f8a55;
  -webkit-tap-highlight-color: transparent;
}
.bigStartBtn:active{ transform:scale(.98); }
@keyframes pulse{
  0%{box-shadow:0 18px 65px #ff2f8a55, 0 0 0 0 #ff4da6aa}
  70%{box-shadow:0 18px 65px #ff2f8a55, 0 0 0 35px transparent}
  100%{box-shadow:0 18px 65px #ff2f8a55, 0 0 0 0 transparent}
}

/* ETAP 2 */
.stage2{ background:transparent; }
.askBox{
  width:clamp(320px,86vw,680px);
  padding:clamp(22px,6vw,60px);
  border-radius:28px;
  background:#ffffff14;
  border:1px solid #ffffff22;
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  text-align:center;
  box-shadow:0 22px 70px #00000066;
}
.askTitle{
  font-family:"Great Vibes",cursive;
  font-size:clamp(36px,8vw,74px);
  line-height:1;
}
.askSubtitle{
  margin-top:12px;
  font-size:clamp(14px,3.2vw,18px);
  color:#ffd0ffdd;
}
.btnRow{
  margin-top:clamp(18px,4vw,34px);
  display:flex;
  justify-content:center;
  gap:clamp(12px,3vw,30px);
  flex-wrap:wrap;
}
.btn{
  padding:clamp(14px,3vw,18px) clamp(22px,5vw,38px);
  border-radius:999px;
  border:none;
  font-size:clamp(16px,3.5vw,26px);
  font-weight:900;
  cursor:pointer;
  box-shadow:0 16px 40px #00000035;
  -webkit-tap-highlight-color: transparent;
}
.btn:active{ transform:scale(.98); }
.yesBtn{ background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#120016; }
.noBtn{ background:#ffffff20; color:var(--text); border:1px solid #ffffff30; }

/* ===== ETAP 3 (IKONY) ===== */
.ui{
  position:fixed;
  inset:0;
  z-index:20;
  pointer-events:none;
}

.iconDock{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  z-index:30;
  pointer-events:auto;
}

.iconsGrid{
  width:min(980px, 94vw);
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:clamp(14px, 3vw, 26px);
  padding:clamp(14px, 3vw, 18px);
}
@media (max-width:900px){ .iconsGrid{ grid-template-columns:repeat(3, minmax(0,1fr)); } }
@media (max-width:520px){ .iconsGrid{ grid-template-columns:repeat(2, minmax(0,1fr)); } }

/* ikony wchodzƒÖ dopiero po dodaniu .go (sterowane JS) */
.appIcon{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  opacity:0;
  transform:translateY(10px) scale(.985);
}
.appIcon.go{
  animation: appIn .65s ease forwards;
}
@keyframes appIn{
  to { opacity:1; transform:translateY(0) scale(1); }
}

.iconBtn{
  width:clamp(78px, 16vw, 108px);
  height:clamp(78px, 16vw, 108px);
  border-radius:24px;
  border:1px solid rgba(255,255,255,.22);
  background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
  box-shadow:0 18px 60px rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display:grid;
  place-items:center;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.iconBtn:active{ transform:scale(.98); }
.iconEmoji{ font-size:40px; line-height:1; }
.iconLabel{
  font-weight:900;
  color:#ffffff;
  font-size:clamp(13px, 3vw, 15px);
  text-align:center;
  text-shadow:0 4px 14px rgba(0,0,0,.9);
  letter-spacing:.5px;
}

/* ===== MODALE ===== */
.modal{
  position:fixed;
  inset:0;
  background:transparent; /* usuniƒôte czarne t≈Ço */
  z-index:200;
  display:none;
  pointer-events:auto;
}
.modal.show{ display:grid; place-items:center; }

.modalCard{
  width:100%;
  max-height:100vh;
  background:transparent;
  border:none;
  box-shadow:none;
  padding:0;
  position:relative;
  overflow:hidden;
}

/* Zamknij */
.closeBtn{
  position:absolute;
  top:14px;
  right:16px;
  z-index:20;
  border:none;
  cursor:pointer;
  background:transparent;
  color:#240018;
  font-size:28px;
  font-weight:900;
  line-height:1;
}
.closeBtn:active{ transform:scale(.95); }

/* ===== List modal ===== */
.letterShell{
  width:100%;
  display:grid;
  place-items:center;
  padding:10px 0 14px;
  position:relative;
}

/* MP4 animacja koperty (warstwa) */
.envelopeHero{
  width:min(620px, 94vw);
  height:clamp(190px, 36vw, 320px);
  position:relative;
  margin:8px auto 0;
  filter:none;
  display:grid;
  place-items:center;
}


.envVideo{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:22px;
  opacity:1;
  transform: translateZ(0);
  transition: opacity 1s ease, transform 1s ease;
  pointer-events:none;
}
.envVideo.fadeOut{
  opacity:0;
  transform: translateY(14px) scale(.985);
}

/* Papier uk≈Çadamy NA kopercie, ale wizualnie jak kartka po≈Ço≈ºona na kopercie */
.paper{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:stretch;

  background:linear-gradient(180deg, #fff, var(--paper));
  color:var(--paperText);
  border-radius:22px;
  border:none;
  box-shadow:none;
  padding:clamp(18px, 4vw, 32px);

  z-index:3;
  opacity:1;
  transform: translateY(-8px) scale(1) rotate(-0.35deg);
  transition: opacity 1s ease, transform 1s cubic-bezier(.2,.9,.2,1);
}

.paper.isHidden{
  opacity:0;
  transform: translateY(12px) scale(.92) rotate(-0.35deg);
  pointer-events:none;
  visibility:hidden;
}
.paper.show{
  opacity:1;
  transform: translateY(-8px) scale(1) rotate(-0.35deg);
  visibility:visible;
}

/* Papier:  p≈Çynnie pojawia siƒô pod znikajƒÖcƒÖ kopertƒÖ (bez przeskoku) */
.paper{
  width:100%;
  height:100%;
  z-index:3;
  background:linear-gradient(180deg, #fff, var(--paper));
  color:var(--paperText);
  border-radius:22px;
  border:1px solid rgba(0,0,0,.08);
  box-shadow:none;
  padding:clamp(18px, 4vw, 32px);

  position:relative; /* dla X */
  opacity:1;
  transform: translateY(-8px) scale(1) rotate(-0.35deg);
  transition: opacity 1s ease, transform 1s cubic-bezier(.2,.9,.2,1);
}
.paper.isHidden{
  opacity:0;
  transform: translateY(8px) scale(.92) rotate(-0.35deg);
  pointer-events:none;
  visibility:hidden;
}
.paper.show{
  opacity:1;
  transform: translateY(-8px) scale(1) rotate(-0.35deg);
  visibility:visible;
}

.paperTop{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.paperDate{
  font-size:12px;
  color:rgba(0,0,0,.55);
  font-weight:900;
}
.paperTitle{
  font-family:"Great Vibes",cursive;
  font-size:var(--paper-title);
  margin:8px 0 6px;
  line-height:1.05;
}
.paperBody{
  font-family:"Cormorant Garamond",serif;
  font-size:var(--paper-font);
  line-height:1.55;
}
.paperBody p{ margin:10px 0; }
.paperSign{
  margin-top:14px;
  font-family:"Great Vibes",cursive;
  font-size:clamp(22px, 5vw, 40px);
  text-align:right;
}

/* ===== Album modal (scroll g√≥ra/d√≥≈Ç) ===== */
.albumCard{
  overflow:hidden;
}
.albumScroller{
  max-height:76vh;
  overflow-y:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling: touch;
  padding-right:6px;
  margin-top:54px; /* pod przyciskiem zamknij */
}
.albumGrid{
  display:grid;
  grid-template-columns:repeat(3, minmax(0,1fr));
  gap:12px;
}
@media (max-width:700px){ .albumGrid{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
@media (max-width:420px){ .albumGrid{ grid-template-columns:repeat(1, minmax(0,1fr)); } }

.thumb{
  border-radius:18px;
  overflow:hidden;
  position:relative;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 14px 40px rgba(0,0,0,.35);
  aspect-ratio: 1 / 1;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.thumb::after{
  content:"";
  position:absolute;
  inset:0;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  pointer-events:none;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  opacity:0;
  transform:scale(1);
  transition:opacity .35s ease, transform .25s ease;
}
.thumb.loaded img{ opacity:1; }
.thumb:hover img{ transform:scale(1.03); }

/* ===== Lightbox ===== */
#lightbox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.86);
  display:none;
  place-items:center;
  z-index:999;
  cursor:pointer;
  padding:18px;
}
#lightbox.show{ display:grid; }
#lightbox img{
  max-width:min(1200px, 96vw);
  max-height:92vh;
  border-radius:22px;
  box-shadow:0 30px 90px rgba(0,0,0,.75);
}
  </style>
</head>

<body>
  <video id="bgVideo" muted loop playsinline preload="auto">
    <source src="background.mp4" type="video/mp4">
  </video>

  <!-- ETAP 1 -->
  <div id="stage1" class="stage stage1">
    <button id="startBigBtn" class="bigStartBtn">Kliknij</button>
  </div>

  <!-- ETAP 2 -->
  <div id="stage2" class="stage stage2 hidden">
    <div class="askBox">
      <div class="askTitle">Mam pytanie‚Ä¶ üíû</div>
      <div class="askSubtitle">Czy zostaniesz mojƒÖ walentynkƒÖ ?</div>
      <div class="btnRow">
        <button id="yesBtn" class="btn yesBtn">Tak</button>
        <button id="noBtn" class="btn noBtn">Nie</button>
      </div>
    </div>
  </div>

  <!-- ETAP 3 -->
  <div class="ui">
    <div class="iconDock hidden" id="iconDock" aria-hidden="true">
      <div class="iconsGrid" id="iconsGrid"></div>
    </div>
  </div>

  <!-- MODAL: LIST -->
  <div class="modal" id="letterModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true">
      <button class="closeBtn" id="closeLetter" type="button">‚úï</button>

      <div class="letterShell">
        <div class="envelopeHero" id="envelopeHero">
          <video id="envVideo" class="envVideo" muted playsinline preload="auto">
            <source src="envelope.mp4" type="video/mp4">
          </video>
        </div>

        <div class="paper isHidden" id="paper">
 isHidden" id="paper">
          <div class="paperTop">
            <div class="paperDate" id="paperDate">‚Äî</div>
          </div>
          <div class="paperTitle" id="paperTitle">‚Äî</div>
          <div class="paperBody" id="paperBody"></div>
          <div class="paperSign" id="paperSign">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: ALBUM -->
  <div class="modal" id="albumModal" aria-hidden="true">
    <div class="modalCard albumCard" role="dialog" aria-modal="true">
      <button class="closeBtn" id="closeAlbum" type="button">‚úï</button>
      <div class="albumScroller" id="albumScroller">
        <div class="albumGrid" id="albumGrid"></div>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" aria-hidden="true" title="Kliknij, aby zamknƒÖƒá">
    <img id="lightboxImg" alt="Powiƒôkszone zdjƒôcie">
  </div>

  <audio id="music" preload="auto" loop>
    <source src="music.mp3" type="audio/mpeg">
  </audio>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const stage1 = document.getElementById("stage1");
  const stage2 = document.getElementById("stage2");
  const startBtn = document.getElementById("startBigBtn");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn  = document.getElementById("noBtn");

  const bgVideo = document.getElementById("bgVideo");
  const music = document.getElementById("music");

  const iconDock = document.getElementById("iconDock");
  const iconsGrid = document.getElementById("iconsGrid");

  // Modals
  const letterModal = document.getElementById("letterModal");
  const albumModal = document.getElementById("albumModal");
  const closeLetter = document.getElementById("closeLetter");
  const closeAlbum = document.getElementById("closeAlbum");

  const envVideo = document.getElementById("envVideo");
  const paper = document.getElementById("paper");
  const paperDate = document.getElementById("paperDate");
  const paperTitle = document.getElementById("paperTitle");
  const paperBody  = document.getElementById("paperBody");
  const paperSign  = document.getElementById("paperSign");

  const albumGrid = document.getElementById("albumGrid");

  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");

  // Kliknij / Dotknij
  function isTouch(){
    return matchMedia("(pointer:coarse)").matches && !matchMedia("(pointer:fine)").matches;
  }
  function updateStartText(){
    startBtn.textContent = isTouch() ? "Dotknij" : "Kliknij";
  }
  updateStartText();
  addEventListener("resize", updateStartText);

  // Muzyka (g≈Ço≈õno≈õƒá)
  const MUSIC_VOL = 0.25;
  const clamp01 = (v)=> Math.max(0, Math.min(1, v));
  function fadeTo(el, target, ms=900){
    const to = clamp01(target);
    const from = clamp01(el.volume ?? 0);
    const t0 = performance.now();
    const tick = (t)=>{
      const k = Math.min(1, (t - t0)/ms);
      el.volume = clamp01(from + (to - from)*k);
      if(k < 1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  // Etap 1 -> 2
  startBtn.addEventListener("click", () => {
    stage1.classList.add("hidden");
    stage2.classList.remove("hidden");
  });

  // Etap 2: zmiana tekst√≥w na "Nie"
  let noCount = 0;
  const noPhrases = ["Nie","Na pewno nie üòè","Spr√≥buj jeszcze raz","Prawie üò≥","No dobrze‚Ä¶"];
  noBtn.addEventListener("click", () => {
    if(noCount >= noPhrases.length - 1){
      noBtn.textContent = "Tak <3";
      noBtn.style.background = "linear-gradient(135deg,#ff4da6,#ff7aa8)";
      noBtn.style.color = "#120016";
      noBtn.style.border = "0";
      noBtn.onclick = goStage3;
      return;
    }
    noBtn.textContent = noPhrases[++noCount];
  });

  yesBtn.addEventListener("click", goStage3);

  // ===== LISTY =====
  const letters = [
    {
      id: "bday-2026-02-06",
      date: "06.02.2026",
      emoji: "üéÇ",
      title: "Wszystkiego najlepszego! üéÇüíñ",
      body: [
        "W dniu Twoich urodzin chcƒô Ci powiedzieƒá, ≈ºe jeste≈õ najpiƒôkniejszƒÖ czƒô≈õciƒÖ mojego ≈õwiata.",
        "≈ªyczƒô Ci spe≈Çnienia marze≈Ñ, spokoju w sercu i codziennych powod√≥w do u≈õmiechu ‚Äî takich, kt√≥re zostajƒÖ na d≈Çugo.",
        "Niech ka≈ºdy dzie≈Ñ przynosi Ci dobro, ciep≈Ço i ludzi, przy kt√≥rych czujesz siƒô kochana i bezpieczna.",
        "A ja‚Ä¶ obiecujƒô byƒá obok ‚Äî wspieraƒá Ciƒô, trzymaƒá za rƒôkƒô i kochaƒá Ciƒô coraz mocniej. üíû"
      ],
      sign: "‚Äì Mateusz"
    },
    {
      id: "val-2026-02-14",
      date: "14.02.2026",
      emoji: "üíå",
      title: "Dla Ciebie üíñ",
      body: [
        "Chcƒô, ≈ºeby≈õ wiedzia≈Ça, ≈ºe jeste≈õ moim spokojem i mojƒÖ rado≈õciƒÖ.",
        "Ka≈ºdy dzie≈Ñ z TobƒÖ jest jak ma≈Çe ≈õwiƒôto ‚Äî nawet gdy jest zwyczajny.",
        "Dziƒôkujƒô, ≈ºe jeste≈õ. üíû",
        "Kocham Ciƒô mocniej ni≈º wczoraj i s≈Çabiej ni≈º jutro. üíñ"
      ],
      sign: "‚Äì Mateusz"
    }
  ];

  function parsePLDate(d){
    const [dd,mm,yyyy] = d.split(".").map(Number);
    return new Date(yyyy, mm-1, dd);
  }
  letters.sort((a,b)=> parsePLDate(a.date) - parsePLDate(b.date));

  // ===== ZDJƒòCIA =====
  const photoFiles = Array.from({length:10}, (_,i)=> `photos/${String(i+1).padStart(2,"0")}.jpeg`);

  // ===== IKONY =====
  function buildIcons(){
    iconsGrid.innerHTML = "";

    // Album zawsze pierwszy
    iconsGrid.appendChild(makeAppIcon({
      id: "album",
      emoji: "üìñ",
      label: "Album",
      onClick: openAlbum
    }));

    // Potem listy (po dacie)
    letters.forEach((L)=>{
      iconsGrid.appendChild(makeAppIcon({
        id: L.id,
        emoji: L.emoji || "üíå",
        label: L.date,
        onClick: ()=> openLetter(L.id)
      }));
    });
  }

  function makeAppIcon({id, emoji, label, onClick}){
    const wrap = document.createElement("div");
    wrap.className = "appIcon";
    wrap.dataset.id = id;

    const btn = document.createElement("button");
    btn.className = "iconBtn";
    btn.type = "button";
    btn.setAttribute("aria-label", label);

    const em = document.createElement("div");
    em.className = "iconEmoji";
    em.textContent = emoji;

    const lab = document.createElement("div");
    lab.className = "iconLabel";
    lab.textContent = label;

    btn.appendChild(em);
    wrap.appendChild(btn);
    wrap.appendChild(lab);

    btn.addEventListener("click", onClick);
    return wrap;
  }

  // pojawianie ikon: album po 3s, kolejne co 1s
  function revealIconsStagger(){
    const items = Array.from(document.querySelectorAll(".appIcon"));
    items.forEach((el, i)=>{
      setTimeout(()=> el.classList.add("go"), 3000 + i * 1000);
    });
  }

  // ===== LIST MODAL =====
  function renderLetter(L){
    paperDate.textContent = L.date;
    paperTitle.textContent = L.title;
    paperSign.textContent = L.sign;

    paperBody.innerHTML = "";
    L.body.forEach(t=>{
      const p = document.createElement("p");
      p.textContent = t;
      paperBody.appendChild(p);
    });
  }

  // dopasowanie tekstu do ekranu (bez scrolla w li≈õcie)
  function fitPaperToViewport(){
    // reset do warto≈õci bazowych
    document.documentElement.style.setProperty("--paper-title", "clamp(32px, 7vw, 62px)");
    document.documentElement.style.setProperty("--paper-font",  "clamp(18px, 3.8vw, 26px)");

    // papier jest ju≈º widoczny, mierzymy i ewentualnie zmniejszamy
    const card = letterModal.querySelector(".modalCard");
    const shell = letterModal.querySelector(".letterShell");
    const envH = letterModal.querySelector(".envelopeHero")?.getBoundingClientRect().height || 0;

    // ile miejsca na papier? (92vh to max modalCard, ale mamy padding i kopertƒô)
    const viewportH = Math.min(window.innerHeight * 0.92, window.innerHeight - 24);
    const cardStyle = getComputedStyle(card);
    const padV = parseFloat(cardStyle.paddingTop) + parseFloat(cardStyle.paddingBottom);

    const available = viewportH - padV - envH - 28; // margines
    if(available < 240) return; // ekstremalnie ma≈Ço miejsca

    // iteracyjnie zmniejszaj font, je≈õli papier przekracza dostƒôpne miejsce
    // (dla aktualnej zawarto≈õci to zwykle 0-3 kroki)
    let titleMax = 62;
    let bodyMax  = 26;

    // tymczasowo ustaw "max" jako konkret (≈Çatwiej kontrolowaƒá)
    function applySizes(){
      document.documentElement.style.setProperty("--paper-title", `${titleMax}px`);
      document.documentElement.style.setProperty("--paper-font",  `${bodyMax}px`);
    }

    applySizes();
    // je≈õli papier jest wiƒôkszy ni≈º available, zmniejszamy
    for(let i=0;i<16;i++){
      const paperRect = paper.getBoundingClientRect();
      const paperH = paperRect.height;
      if(paperH <= available) break;
      // zmniejszaj delikatnie
      titleMax = Math.max(28, titleMax - 2);
      bodyMax  = Math.max(14, bodyMax - 1);
      applySizes();
    }
  }

  function openLetter(id){
    const L = letters.find(x=>x.id === id) || letters[0];
    renderLetter(L);

    // przygotuj: najpierw MP4 animacja koperty, list ukryty
    paper.classList.add("isHidden");
    paper.classList.remove("show");

    // reset wideo
    envVideo.classList.remove("fadeOut");
    try{
      envVideo.pause();
      envVideo.currentTime = 0;
    }catch(e){}

    letterModal.classList.add("show");
    letterModal.setAttribute("aria-hidden","false");

    // odtw√≥rz animacjƒô (po klikniƒôciu ‚Äì bez autoplay)
    const playPromise = envVideo.play();
    if(playPromise && typeof playPromise.catch === "function"){
      playPromise.catch(()=>{});
    }

    // po zako≈Ñczeniu animacji: wideo zanika, list pojawia siƒô w jego miejscu (1s)
    const reveal = ()=>{
      envVideo.removeEventListener("ended", reveal);
      envVideo.classList.add("fadeOut");
      paper.classList.remove("isHidden");
      requestAnimationFrame(()=> paper.classList.add("show"));
      setTimeout(fitPaperToViewport, 80);
    };

    // je≈õli "ended" nie zadzia≈Ça (np. brak pliku), fallback po ~1.4s
    envVideo.addEventListener("ended", reveal, { once:true });
    setTimeout(()=>{
      // je≈õli wideo ju≈º zanik≈Ço/nie gra, nie r√≥b drugi raz
      if(letterModal.classList.contains("show") && paper.classList.contains("isHidden")){
        reveal();
      }
    }, 1400);
  }

  function closeLetterModal(){
    letterModal.classList.remove("show");
    letterModal.setAttribute("aria-hidden","true");

    // reset stanu
    paper.classList.add("isHidden");
    paper.classList.remove("show");

    envVideo.classList.remove("fadeOut");
    try{ envVideo.pause(); }catch(e){}
  }

  closeLetter.addEventListener("click", (e)=>{ e.stopPropagation(); closeLetterModal(); });
  letterModal.addEventListener("click", (e)=>{
    if(e.target === letterModal) closeLetterModal();
  });

  addEventListener("resize", ()=>{
    if(letterModal.classList.contains("show") && !paper.classList.contains("isHidden")){
      fitPaperToViewport();
    }
  });

  // ===== ALBUM MODAL (scroll g√≥ra/d√≥≈Ç) =====
  function buildAlbum(){
    albumGrid.innerHTML = "";
    photoFiles.forEach((src, idx)=>{
      const div = document.createElement("div");
      div.className = "thumb";
      div.setAttribute("role","button");
      div.setAttribute("tabindex","0");
      div.setAttribute("aria-label", `Otw√≥rz zdjƒôcie ${idx+1}`);

      const img = document.createElement("img");
      img.alt = `Zdjƒôcie ${idx+1}`;
      img.src = src;
      img.addEventListener("load", ()=> div.classList.add("loaded"));
      img.addEventListener("error", ()=> div.classList.remove("loaded"));

      const open = ()=> openLightbox(src, img.alt);
      div.addEventListener("click", open);
      div.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          open();
        }
      });

      div.appendChild(img);
      albumGrid.appendChild(div);
    });
  }

  function openAlbum(){
    albumModal.classList.add("show");
    albumModal.setAttribute("aria-hidden","false");
  }

  function closeAlbumModal(){
    albumModal.classList.remove("show");
    albumModal.setAttribute("aria-hidden","true");
  }

  closeAlbum.addEventListener("click", (e)=>{ e.stopPropagation(); closeAlbumModal(); });
  albumModal.addEventListener("click", (e)=>{
    if(e.target === albumModal) closeAlbumModal();
  });

  // ===== LIGHTBOX =====
  function openLightbox(src, alt){
    lightboxImg.src = src;
    lightboxImg.alt = alt || "Zdjƒôcie";
    lightbox.classList.add("show");
    lightbox.setAttribute("aria-hidden","false");
  }
  function closeLightbox(){
    lightbox.classList.remove("show");
    lightbox.setAttribute("aria-hidden","true");
  }
  lightbox.addEventListener("click", closeLightbox);

  addEventListener("keydown", (e)=>{
    if(e.key !== "Escape") return;
    if(lightbox.classList.contains("show")) closeLightbox();
    else if(letterModal.classList.contains("show")) closeLetterModal();
    else if(albumModal.classList.contains("show")) closeAlbumModal();
  });

  // ===== Etap 3 =====
  function goStage3(){
    stage2.classList.add("hidden");

    // start video i muzyka w ge≈õcie usera
    bgVideo.style.opacity = 1;
    bgVideo.play().catch(()=>{});

    music.currentTime = 0;
    music.volume = 0;
    music.play().catch(()=>{});
    fadeTo(music, MUSIC_VOL, 900);

    buildIcons();
    buildAlbum();

    iconDock.classList.remove("hidden");
    iconDock.setAttribute("aria-hidden","false");

    // ikony pojawiajƒÖ siƒô dopiero po 3s (album) i co 1s kolejne
    revealIconsStagger();
  }

});
</script>
</body>
</html>
